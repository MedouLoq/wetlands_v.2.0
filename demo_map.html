<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive Avanc√©e - GeoWetlands Mauritania</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" />
    
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        /* Enhanced Map Styles for GeoWetlands Mauritania */

        /* Map Container */
        .map-container {
            position: relative;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }

        /* Map Loading */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Markers */
        .custom-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .custom-marker:hover {
            transform: scale(1.1);
        }

        .ramsar-marker {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-color: #ffc107;
        }

        .wetland-marker {
            background: linear-gradient(135deg, #1a7a4c, #2e8b57);
            border-color: #28a745;
        }

        /* Custom Popups */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .map-popup {
            min-width: 250px;
        }

        .popup-header {
            padding: 10px;
            margin: -10px -10px 10px -10px;
            border-radius: 10px 10px 0 0;
            color: white;
        }

        .ramsar-header {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .wetland-header {
            background: linear-gradient(135deg, #1a7a4c, #2e8b57);
        }

        .ramsar-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 14px;
        }

        .popup-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        /* Map Controls */
        .map-controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        /* Search Control */
        .search-control {
            position: relative;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            color: #666;
            z-index: 1;
        }

        .search-spinner {
            position: absolute;
            right: 10px;
            color: #007bff;
        }

        #map-search {
            padding-left: 35px;
            padding-right: 35px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-result-item {
            border-bottom: 1px solid #eee;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-content {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-content:hover {
            background-color: #f8f9fa;
        }

        .search-result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .search-result-icon {
            width: 16px;
            color: #007bff;
        }

        .search-result-description {
            font-size: 12px;
            color: #666;
            margin-left: 24px;
        }

        .search-no-results,
        .search-error {
            padding: 10px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .search-error {
            color: #dc3545;
        }

        /* Legend */
        .legend {
            background: white;
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            line-height: 1.4;
            max-width: 250px;
            min-width: 200px;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px 10px 0 0;
            margin: 0;
        }

        .legend-header h6 {
            margin: 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .legend-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .legend-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .legend-section {
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .legend-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .legend-section h7 {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            gap: 10px;
            padding: 2px 0;
            transition: background-color 0.2s ease;
            border-radius: 3px;
            padding: 4px 6px;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
        }

        .legend-item i {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }

        .legend-item span {
            font-size: 12px;
            color: #495057;
        }

        .heatmap-gradient {
            width: 35px;
            height: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        .heatmap-gradient.wetlands {
            background: linear-gradient(to right, #3388ff, #ffff00, #ff0000);
        }

        .heatmap-gradient.species {
            background: linear-gradient(to right, #00ff00, #ffff00, #ff6600);
        }

        .wilaya-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        /* Danger Indicators */
        .danger-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px dashed #fff;
            flex-shrink: 0;
            position: relative;
        }

        .danger-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
        }

        .danger-indicator.high {
            background-color: #d32f2f;
            border-color: #d32f2f;
        }

        .danger-indicator.medium {
            background-color: #ff9800;
            border-color: #ff9800;
        }

        .danger-indicator.low {
            background-color: #ffc107;
            border-color: #ffc107;
        }

        /* Measurement Tool Styles */
        .measure-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .measure-marker.start {
            background-color: #28a745;
        }

        .measure-marker.end {
            background-color: #dc3545;
        }

        .measure-result {
            text-align: center;
            min-width: 200px;
        }

        .measure-result h6 {
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .measure-result p {
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
        }

        .temp-search-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: searchPulse 2s ease-in-out infinite;
        }

        @keyframes searchPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        /* Statistics Cards */
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #007bff;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Header */
        .detail-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 60px 0;
            text-align: center;
        }

        .detail-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .detail-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Leaflet Control Customization */
        .leaflet-control-layers {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .leaflet-control-zoom {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .leaflet-control-zoom a {
            border-radius: 0;
        }

        .leaflet-control-zoom a:first-child {
            border-radius: 10px 10px 0 0;
        }

        .leaflet-control-zoom a:last-child {
            border-radius: 0 0 10px 10px;
        }

        /* Custom Control Styles */
        .leaflet-control-custom {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .leaflet-control-custom:hover {
            background-color: #f8f9fa !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .map-container {
                height: 400px;
                border-radius: 10px;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .filter-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .legend {
                font-size: 12px;
                padding: 10px;
            }
            
            .stat-card {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .stat-icon {
                font-size: 2rem;
            }
            
            .detail-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <section class="detail-header">
        <div class="container">
            <h1 class="detail-title" data-aos="fade-up">
                <i class="fas fa-map-marked-alt"></i> Carte Interactive Avanc√©e
            </h1>
            <p class="detail-subtitle" data-aos="fade-up" data-aos-delay="200">
                Explorez les zones humides mauritaniennes avec des outils g√©ographiques avanc√©s
            </p>
        </div>
    </section>

    <!-- Map Controls -->
    <section class="container mb-4 mt-5">
        <div class="map-controls" data-aos="fade-up">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="region-filter" class="form-label">
                        <i class="fas fa-map-marker-alt"></i> Filtrer par Wilaya
                    </label>
                    <select id="region-filter" class="form-select" onchange="filterByRegion(this.value)">
                        <option value="all">Toutes les Wilayas</option>
                        <option value="Adrar">Adrar</option>
                        <option value="Assaba">Assaba</option>
                        <option value="Brakna">Brakna</option>
                        <option value="Dakhlet Nouadhibou">Dakhlet Nouadhibou</option>
                        <option value="Gorgol">Gorgol</option>
                        <option value="Guidimaka">Guidimaka</option>
                        <option value="Hodh ech Chargui">Hodh ech Chargui</option>
                        <option value="Hodh el Gharbi">Hodh el Gharbi</option>
                        <option value="Inchiri">Inchiri</option>
                        <option value="Nouakchott">Nouakchott</option>
                        <option value="Tagant">Tagant</option>
                        <option value="Tiris Zemmour">Tiris Zemmour</option>
                        <option value="Trarza">Trarza</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="type-filter" class="form-label">
                        <i class="fas fa-filter"></i> Type de Site
                    </label>
                    <select id="type-filter" class="form-select" onchange="filterByType(this.value)">
                        <option value="all">Tous les Sites</option>
                        <option value="ramsar">Sites Ramsar Uniquement</option>
                        <option value="wetland">Zones Humides Locales</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="site-search" class="form-label">
                        <i class="fas fa-search"></i> Recherche Rapide
                    </label>
                    <input type="text" id="site-search" class="form-control" placeholder="Nom du site ou wilaya...">
                </div>
            </div>
            
            <!-- Quick Filter Buttons -->
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="showAllSites()">
                    <i class="fas fa-globe"></i> Tous
                </button>
                <button class="filter-btn" onclick="showRamsarOnly()">
                    <i class="fas fa-star"></i> Sites Ramsar
                </button>
                <button class="filter-btn" onclick="showByImportance()">
                    <i class="fas fa-exclamation-triangle"></i> Prioritaires
                </button>
                <button class="filter-btn" onclick="toggleHeatmap()">
                    <i class="fas fa-fire"></i> Carte de Chaleur
                </button>
            </div>
        </div>
    </section>

    <!-- Map Container -->
    <section class="container mb-5">
        <div class="row">
            <div class="col-12">
                <div class="map-container" data-aos="fade-up">
                    <div id="map"></div>
                    <div id="map-loading" class="map-loading">
                        <div class="spinner"></div>
                        <p>Chargement de la carte...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Statistics Section -->
    <section class="container mb-5">
        <div class="row text-center" data-aos="fade-up">
            <div class="col-md-3 col-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-number" data-count="4">0</div>
                    <div class="stat-label">Sites Ramsar</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="stat-number" data-count="25">0</div>
                    <div class="stat-label">Zones Humides</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-map"></i>
                    </div>
                    <div class="stat-number" data-count="13">0</div>
                    <div class="stat-label">Wilayas Couvertes</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div class="stat-number" data-count="1240600">0</div>
                    <div class="stat-label">Hectares Prot√©g√©s</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // Initialize AOS
        AOS.init();

        // Sample data for demonstration
        const sampleSites = [
            {
                id: 1,
                name: "Parc National du Banc d'Arguin",
                region: "Dakhlet Nouadhibou",
                commune: "Nouadhibou",
                lat: 20.2,
                lng: -16.3,
                isRamsar: true
            },
            {
                id: 2,
                name: "Chat Tboul",
                region: "Trarza",
                commune: "Rosso",
                lat: 16.5,
                lng: -15.8,
                isRamsar: true
            },
            {
                id: 3,
                name: "Lac Gabou",
                region: "Hodh ech Chargui",
                commune: "Bassiknou",
                lat: 15.8,
                lng: -5.9,
                isRamsar: true
            },
            {
                id: 4,
                name: "Diawling",
                region: "Trarza",
                commune: "Keur Mass√®ne",
                lat: 16.3,
                lng: -16.1,
                isRamsar: true
            },
            {
                id: 5,
                name: "Sebkha de Ndrhamcha",
                region: "Inchiri",
                commune: "Akjoujt",
                lat: 19.7,
                lng: -14.4,
                isRamsar: false
            },
            {
                id: 6,
                name: "Lac de Mal",
                region: "Brakna",
                commune: "Aleg",
                lat: 17.1,
                lng: -13.9,
                isRamsar: false
            },
            {
                id: 7,
                name: "Tamourt en Naaj",
                region: "Adrar",
                commune: "Atar",
                lat: 20.5,
                lng: -13.0,
                isRamsar: false
            },
            {
                id: 8,
                name: "Sebkha de Trarza",
                region: "Trarza",
                commune: "Boutilimit",
                lat: 17.5,
                lng: -14.7,
                isRamsar: false
            }
        ];

        // Sample species data
        const sampleSpeciesData = [
            { lat: 20.2, lng: -16.3, species: "Flamant rose", type: "Bird" },
            { lat: 16.5, lng: -15.8, species: "P√©lican blanc", type: "Bird" },
            { lat: 15.8, lng: -5.9, species: "Crocodile du Nil", type: "Reptile" },
            { lat: 16.3, lng: -16.1, species: "Lamantin", type: "Mammal" },
            { lat: 19.7, lng: -14.4, species: "Tilapia", type: "Fish" },
            { lat: 17.1, lng: -13.9, species: "N√©nuphar", type: "Plant" }
        ];

        // Sample threats data
        const sampleThreatsData = [
            { lat: 20.2, lng: -16.3, threat: "Pollution marine", level: "high" },
            { lat: 16.5, lng: -15.8, threat: "Surp√™che", level: "medium" },
            { lat: 15.8, lng: -5.9, threat: "S√©cheresse", level: "high" },
            { lat: 17.1, lng: -13.9, threat: "Urbanisation", level: "medium" }
        ];

        // Sample wilayas data
        const sampleWilayasData = [
            { name: "Dakhlet Nouadhibou", siteCount: 3, color: "#d32f2f" },
            { name: "Trarza", siteCount: 4, color: "#d32f2f" },
            { name: "Hodh ech Chargui", siteCount: 2, color: "#ff9800" },
            { name: "Inchiri", siteCount: 1, color: "#ff9800" },
            { name: "Brakna", siteCount: 1, color: "#ff9800" },
            { name: "Adrar", siteCount: 1, color: "#ff9800" },
            { name: "Assaba", siteCount: 0, color: "#9e9e9e" }
        ];

        let map;
        let siteMarkers = [];
        let heatmapLayer;
        let speciesHeatmapLayer;
        let wilayasLayer;
        let layerControl;
        let currentFilter = 'all';

        // Map layers
        let baseLayers = {};
        let overlayLayers = {};

        // Initialize enhanced map
        function initializeMap() {
            // Create map centered on Mauritania
            map = L.map('map', {
                center: [20.5, -10.5],
                zoom: 6,
                zoomControl: false,
                attributionControl: true
            });

            // Add custom zoom control
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // Define base layers
            baseLayers = {
                "Carte Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }),
                
                "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 18
                }),
                
                "Terrain": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                    maxZoom: 17
                }),
                
                "G√©ographique": L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap France',
                    maxZoom: 20
                })
            };

            // Add default base layer
            baseLayers["Carte Standard"].addTo(map);

            // Initialize overlay layers
            overlayLayers = {
                "Sites Ramsar": L.layerGroup(),
                "Zones Humides": L.layerGroup(),
                "Heatmap Zones Humides": L.layerGroup(),
                "Heatmap Esp√®ces": L.layerGroup(),
                "Wilayas": L.layerGroup(),
                "Esp√®ces: Oiseaux": L.layerGroup(),
                "Esp√®ces: Poissons": L.layerGroup(),
                "Esp√®ces: Mammif√®res": L.layerGroup(),
                "Esp√®ces: Plantes": L.layerGroup(),
                "Zones de Danger": L.layerGroup()
            };

            // Add layer control
            layerControl = L.control.layers(baseLayers, overlayLayers, {
                position: 'topright',
                collapsed: false
            }).addTo(map);

            // Load sample data
            loadSiteData();
            loadHeatmapData();
            loadSpeciesData();
            loadThreatsData();
            
            // Add scale control
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);

            // Add fullscreen control
            map.addControl(new L.Control.Fullscreen({
                title: {
                    'false': 'Voir en plein √©cran',
                    'true': 'Quitter le plein √©cran'
                }
            }));

            // Add search control
            addSearchControl();
            
            // Add custom legend
            addCustomLegend();
            
            // Add measurement tool
            addMeasurementTool();

            // Hide loading
            document.getElementById('map-loading').style.display = 'none';
        }

        // Load and process site data
        function loadSiteData() {
            sampleSites.forEach(site => {
                const isRamsar = site.isRamsar;
                const icon = createCustomIcon(isRamsar);
                
                const marker = L.marker([site.lat, site.lng], { icon: icon })
                    .bindPopup(createPopupContent(site), {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });

                marker._site = site;
                marker._isRamsar = isRamsar;
                
                if (isRamsar) {
                    overlayLayers["Sites Ramsar"].addLayer(marker);
                } else {
                    overlayLayers["Zones Humides"].addLayer(marker);
                }
                
                siteMarkers.push(marker);
            });

            // Add default layers to map
            overlayLayers["Sites Ramsar"].addTo(map);
            overlayLayers["Zones Humides"].addTo(map);

            // Fit map to markers
            if (siteMarkers.length > 0) {
                const group = new L.featureGroup(siteMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Load heatmap data
        function loadHeatmapData() {
            // Wetlands heatmap
            const wetlandsHeatmapData = sampleSites.map(site => [
                site.lat, 
                site.lng, 
                site.isRamsar ? 2.0 : 1.0
            ]);
            
            heatmapLayer = L.heatLayer(wetlandsHeatmapData, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {
                    0.0: '#3388ff',
                    0.5: '#ffff00',
                    1.0: '#ff0000'
                }
            });
            overlayLayers["Heatmap Zones Humides"].addLayer(heatmapLayer);

            // Species heatmap
            const speciesHeatmapData = sampleSpeciesData.map(item => [
                item.lat, 
                item.lng, 
                1.0
            ]);
            
            speciesHeatmapLayer = L.heatLayer(speciesHeatmapData, {
                radius: 20,
                blur: 10,
                maxZoom: 12,
                gradient: {
                    0.0: '#00ff00',
                    0.5: '#ffff00',
                    1.0: '#ff6600'
                }
            });
            overlayLayers["Heatmap Esp√®ces"].addLayer(speciesHeatmapLayer);
        }

        // Load species data
        function loadSpeciesData() {
            const speciesColors = {
                'Bird': '#2196f3',
                'Fish': '#00bcd4',
                'Mammal': '#ff9800',
                'Plant': '#4caf50',
                'Reptile': '#9c27b0'
            };

            sampleSpeciesData.forEach(species => {
                const circle = L.circleMarker([species.lat, species.lng], {
                    radius: 8,
                    fillColor: speciesColors[species.type] || '#607d8b',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <div class="species-popup">
                        <h6><i class="fas fa-paw"></i> ${species.type}</h6>
                        <p><strong>Esp√®ce:</strong> ${species.species}</p>
                    </div>
                `);
                
                overlayLayers[`Esp√®ces: ${species.type}s`] = overlayLayers[`Esp√®ces: ${species.type}s`] || L.layerGroup();
                overlayLayers[`Esp√®ces: ${species.type}s`].addLayer(circle);
            });
        }

        // Load threats data
        function loadThreatsData() {
            const threatColors = {
                'high': '#d32f2f',
                'medium': '#ff9800',
                'low': '#ffc107'
            };

            sampleThreatsData.forEach(threat => {
                const dangerZone = L.circle([threat.lat, threat.lng], {
                    radius: 2000,
                    fillColor: threatColors[threat.level],
                    color: threatColors[threat.level],
                    weight: 3,
                    opacity: 0.8,
                    fillOpacity: 0.2,
                    dashArray: '10, 10'
                }).bindPopup(`
                    <div class="threat-popup">
                        <h6><i class="fas fa-exclamation-triangle" style="color: ${threatColors[threat.level]};"></i> Zone de Danger</h6>
                        <p><strong>Menace:</strong> ${threat.threat}</p>
                        <p><strong>Niveau:</strong> ${threat.level}</p>
                    </div>
                `);
                
                overlayLayers["Zones de Danger"].addLayer(dangerZone);
            });
        }

        // Create custom icons
        function createCustomIcon(isRamsar) {
            const iconHtml = isRamsar ? 
                '<i class="fas fa-star" style="color: #ffd700;"></i>' :
                '<i class="fas fa-tint" style="color: #1a7a4c;"></i>';
            
            return L.divIcon({
                html: `<div class="custom-marker ${isRamsar ? 'ramsar-marker' : 'wetland-marker'}">${iconHtml}</div>`,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // Create popup content
        function createPopupContent(site) {
            const isRamsar = site.isRamsar;
            
            return `
                <div class="map-popup">
                    <div class="popup-header ${isRamsar ? 'ramsar-header' : 'wetland-header'}">
                        <h5>${site.name}</h5>
                        ${isRamsar ? '<span class="ramsar-badge"><i class="fas fa-star"></i> Site Ramsar</span>' : ''}
                    </div>
                    <div class="popup-content">
                        <p><i class="fas fa-map-marker-alt"></i> <strong>Wilaya:</strong> ${site.region}</p>
                        <p><i class="fas fa-building"></i> <strong>Commune:</strong> ${site.commune}</p>
                        <div class="popup-actions">
                            <button onclick="zoomToSite(${site.lat}, ${site.lng})" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-search-plus"></i> Zoom
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add search control
        function addSearchControl() {
            const searchControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.padding = '10px';
                    container.style.minWidth = '300px';
                    container.style.borderRadius = '10px';
                    container.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                    
                    container.innerHTML = `
                        <div class="search-control">
                            <div class="search-input-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="map-search" placeholder="Rechercher sites, wilayas, esp√®ces..." class="form-control form-control-sm">
                            </div>
                            <div id="search-results" class="search-results"></div>
                        </div>
                    `;
                    
                    L.DomEvent.disableClickPropagation(container);
                    
                    return container;
                }
            });
            
            map.addControl(new searchControl({ position: 'topleft' }));
            
            // Add search functionality
            setTimeout(() => {
                const searchInput = document.getElementById('map-search');
                const searchResults = document.getElementById('search-results');
                
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const query = this.value.toLowerCase();
                        searchResults.innerHTML = '';
                        
                        if (query.length < 2) return;
                        
                        const matches = sampleSites.filter(site => 
                            site.name.toLowerCase().includes(query) ||
                            site.region.toLowerCase().includes(query)
                        ).slice(0, 5);
                        
                        matches.forEach(site => {
                            const result = document.createElement('div');
                            result.className = 'search-result-item';
                            result.innerHTML = `
                                <div class="search-result-content" onclick="selectSearchResult(${site.lat}, ${site.lng}, '${site.name}')">
                                    <div class="search-result-header">
                                        <i class="fas fa-tint search-result-icon"></i>
                                        <strong>${site.name}</strong>
                                    </div>
                                    <div class="search-result-description">${site.region}</div>
                                </div>
                            `;
                            searchResults.appendChild(result);
                        });
                    });
                }
            }, 1000);
        }

        // Add measurement tool
        function addMeasurementTool() {
            const measureControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.width = '40px';
                    container.style.height = '40px';
                    container.style.cursor = 'pointer';
                    container.style.borderRadius = '10px';
                    container.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                    container.title = 'Outil de mesure de distance';
                    
                    container.innerHTML = '<i class="fas fa-ruler" style="line-height: 40px; text-align: center; display: block; font-size: 16px;"></i>';
                    
                    let measuring = false;
                    let measureLine = null;
                    let startPoint = null;
                    
                    container.onclick = function() {
                        if (!measuring) {
                            measuring = true;
                            container.style.backgroundColor = '#007cff';
                            container.style.color = 'white';
                            map.getContainer().style.cursor = 'crosshair';
                            
                            map.on('click', function(e) {
                                if (!startPoint) {
                                    startPoint = e.latlng;
                                    measureLine = L.polyline([startPoint], {
                                        color: '#ff4444',
                                        weight: 3,
                                        dashArray: '5, 10'
                                    }).addTo(map);
                                } else {
                                    const endPoint = e.latlng;
                                    measureLine.addLatLng(endPoint);
                                    
                                    const distance = startPoint.distanceTo(endPoint);
                                    const distanceText = distance > 1000 ? 
                                        `${(distance / 1000).toFixed(2)} km` : 
                                        `${distance.toFixed(0)} m`;
                                    
                                    L.popup()
                                        .setLatLng(endPoint)
                                        .setContent(`
                                            <div class="measure-result">
                                                <h6><i class="fas fa-ruler"></i> Distance</h6>
                                                <p>${distanceText}</p>
                                            </div>
                                        `)
                                        .openOn(map);
                                    
                                    // Reset
                                    measuring = false;
                                    startPoint = null;
                                    container.style.backgroundColor = 'white';
                                    container.style.color = 'black';
                                    map.getContainer().style.cursor = '';
                                    map.off('click');
                                }
                            });
                        }
                    };
                    
                    L.DomEvent.disableClickPropagation(container);
                    
                    return container;
                }
            });
            
            map.addControl(new measureControl({ position: 'topleft' }));
        }

        // Add custom legend
        function addCustomLegend() {
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML = `
                    <div class="legend-content">
                        <div class="legend-header">
                            <h6><i class="fas fa-info-circle"></i> L√©gende Interactive</h6>
                            <button class="legend-toggle" onclick="toggleLegend()">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        
                        <div class="legend-body" id="legend-body">
                            <div class="legend-section">
                                <h7><strong>Sites</strong></h7>
                                <div class="legend-item">
                                    <i class="fas fa-star" style="color: #ffd700;"></i>
                                    <span>Sites Ramsar</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-tint" style="color: #1a7a4c;"></i>
                                    <span>Zones Humides</span>
                                </div>
                            </div>
                            
                            <div class="legend-section">
                                <h7><strong>Heatmaps</strong></h7>
                                <div class="legend-item">
                                    <div class="heatmap-gradient wetlands"></div>
                                    <span>Densit√© Zones Humides</span>
                                </div>
                                <div class="legend-item">
                                    <div class="heatmap-gradient species"></div>
                                    <span>Densit√© Esp√®ces</span>
                                </div>
                            </div>
                            
                            <div class="legend-section">
                                <h7><strong>Esp√®ces</strong></h7>
                                <div class="legend-item">
                                    <i class="fas fa-dove" style="color: #2196f3;"></i>
                                    <span>Oiseaux</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-fish" style="color: #00bcd4;"></i>
                                    <span>Poissons</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-otter" style="color: #ff9800;"></i>
                                    <span>Mammif√®res</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-seedling" style="color: #4caf50;"></i>
                                    <span>Plantes</span>
                                </div>
                            </div>
                            
                            <div class="legend-section">
                                <h7><strong>Zones de Danger</strong></h7>
                                <div class="legend-item">
                                    <div class="danger-indicator high"></div>
                                    <span>Risque √âlev√©</span>
                                </div>
                                <div class="legend-item">
                                    <div class="danger-indicator medium"></div>
                                    <span>Risque Moyen</span>
                                </div>
                                <div class="legend-item">
                                    <div class="danger-indicator low"></div>
                                    <span>Risque Faible</span>
                                </div>
                            </div>
                            
                            <div class="legend-section">
                                <h7><strong>Outils</strong></h7>
                                <div class="legend-item">
                                    <i class="fas fa-ruler" style="color: #007bff;"></i>
                                    <span>Mesure de Distance</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-search" style="color: #28a745;"></i>
                                    <span>Recherche Avanc√©e</span>
                                </div>
                                <div class="legend-item">
                                    <i class="fas fa-expand" style="color: #6c757d;"></i>
                                    <span>Plein √âcran</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
        }

        // Utility functions
        function toggleLegend() {
            const legendBody = document.getElementById('legend-body');
            const toggleButton = document.querySelector('.legend-toggle i');
            
            if (legendBody.style.display === 'none') {
                legendBody.style.display = 'block';
                toggleButton.className = 'fas fa-chevron-up';
            } else {
                legendBody.style.display = 'none';
                toggleButton.className = 'fas fa-chevron-down';
            }
        }

        function zoomToSite(lat, lng) {
            map.setView([lat, lng], 12);
        }

        function selectSearchResult(lat, lng, name) {
            map.setView([lat, lng], 12);
            
            // Clear search
            const searchInput = document.getElementById('map-search');
            const searchResults = document.getElementById('search-results');
            if (searchInput) searchInput.value = '';
            if (searchResults) searchResults.innerHTML = '';
        }

        function filterByRegion(region) {
            // Implementation for region filtering
            console.log('Filter by region:', region);
        }

        function filterByType(type) {
            // Implementation for type filtering
            console.log('Filter by type:', type);
        }

        function showAllSites() {
            updateFilterButtons(0);
        }

        function showRamsarOnly() {
            updateFilterButtons(1);
        }

        function showByImportance() {
            updateFilterButtons(2);
        }

        function toggleHeatmap() {
            updateFilterButtons(3);
        }

        function updateFilterButtons(activeIndex) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach((btn, index) => {
                if (index === activeIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeMap();
            }, 500);
            
            // Initialize counter animations
            const counters = document.querySelectorAll('.stat-number[data-count]');
            counters.forEach(counter => {
                const target = parseInt(counter.getAttribute('data-count'));
                let current = 0;
                const increment = target / 50;
                
                const updateCounter = () => {
                    if (current < target) {
                        current += increment;
                        counter.textContent = Math.floor(current).toLocaleString();
                        requestAnimationFrame(updateCounter);
                    } else {
                        counter.textContent = target.toLocaleString();
                    }
                };
                
                setTimeout(updateCounter, 1000);
            });
        });
    </script>
</body>
</html>

